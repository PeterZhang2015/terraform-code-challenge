name: Security PR Comment

on:
  pull_request:
    branches: [ master, main ]
    paths:
      - 'wizardai_aws_s3_bucket/**'
      - '.github/workflows/**'

env:
  TF_VERSION: "1.6.0"

jobs:
  security-analysis:
    name: Security Analysis with PR Comment
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: ./wizardai_aws_s3_bucket
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init
      run: terraform init

    - name: Run Checkov
      id: checkov
      run: |
        # Install Checkov
        pip install checkov
        
        # Run Checkov and capture output
        checkov -d . --framework terraform --output cli --quiet > checkov-output.txt 2>&1 || true
        checkov -d . --framework terraform --output sarif --output-file-path checkov-results.sarif --quiet || true
        
        # Parse results
        if [ -f "checkov-output.txt" ]; then
          CHECKOV_ISSUES=$(grep -c "Check:" checkov-output.txt 2>/dev/null || echo "0")
          echo "checkov_issues=$CHECKOV_ISSUES" >> $GITHUB_OUTPUT
        else
          echo "checkov_issues=0" >> $GITHUB_OUTPUT
        fi

    - name: Run tfsec
      id: tfsec
      run: |
        # Install tfsec
        curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
        
        # Run tfsec and capture output
        ./tfsec . --format default --out tfsec-output.txt --soft-fail || true
        ./tfsec . --format sarif --out tfsec-results.sarif --soft-fail || true
        
        # Parse results
        if [ -f "tfsec-output.txt" ]; then
          TFSEC_ISSUES=$(grep -c "Result #" tfsec-output.txt 2>/dev/null || echo "0")
          echo "tfsec_issues=$TFSEC_ISSUES" >> $GITHUB_OUTPUT
        else
          echo "tfsec_issues=0" >> $GITHUB_OUTPUT
        fi

    - name: Run Terrascan
      id: terrascan
      run: |
        # Install Terrascan
        curl -L "$(curl -s https://api.github.com/repos/tenable/terrascan/releases/latest | grep -o -E "https://.+?_Linux_x86_64.tar.gz")" > terrascan.tar.gz
        tar -xf terrascan.tar.gz terrascan && rm terrascan.tar.gz
        chmod +x terrascan
        
        # Run Terrascan
        ./terrascan scan -i terraform -d . --output human > terrascan-output.txt 2>&1 || true
        
        # Parse results
        if [ -f "terrascan-output.txt" ]; then
          TERRASCAN_ISSUES=$(grep -c "Violation Details" terrascan-output.txt 2>/dev/null || echo "0")
          echo "terrascan_issues=$TERRASCAN_ISSUES" >> $GITHUB_OUTPUT
        else
          echo "terrascan_issues=0" >> $GITHUB_OUTPUT
        fi

    - name: Upload SARIF results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: ./wizardai_aws_s3_bucket/checkov-results.sarif
        category: checkov
      continue-on-error: true

    - name: Upload tfsec SARIF results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: ./wizardai_aws_s3_bucket/tfsec-results.sarif
        category: tfsec
      continue-on-error: true

    - name: Generate comprehensive security report
      id: security_report
      run: |
        CHECKOV_ISSUES="${{ steps.checkov.outputs.checkov_issues }}"
        TFSEC_ISSUES="${{ steps.tfsec.outputs.tfsec_issues }}"
        TERRASCAN_ISSUES="${{ steps.terrascan.outputs.terrascan_issues }}"
        TOTAL_ISSUES=$((CHECKOV_ISSUES + TFSEC_ISSUES + TERRASCAN_ISSUES))
        
        # Create comprehensive security report
        cat > security-report.md << 'EOF'
        ## ðŸ›¡ï¸ Security Analysis Report
        
        ### ðŸ“Š Summary
        EOF
        
        if [ "$TOTAL_ISSUES" -eq 0 ]; then
          echo "ðŸŽ‰ **All security scans passed!** No security issues detected." >> security-report.md
        else
          echo "âš ï¸ **$TOTAL_ISSUES total security issues found** across all scanners." >> security-report.md
        fi
        
        echo "" >> security-report.md
        echo "| Scanner | Issues Found | Status |" >> security-report.md
        echo "|---------|--------------|--------|" >> security-report.md
        echo "| Checkov | $CHECKOV_ISSUES | $([ "$CHECKOV_ISSUES" -eq 0 ] && echo "âœ… Pass" || echo "âš ï¸ Issues") |" >> security-report.md
        echo "| tfsec | $TFSEC_ISSUES | $([ "$TFSEC_ISSUES" -eq 0 ] && echo "âœ… Pass" || echo "âš ï¸ Issues") |" >> security-report.md
        echo "| Terrascan | $TERRASCAN_ISSUES | $([ "$TERRASCAN_ISSUES" -eq 0 ] && echo "âœ… Pass" || echo "âš ï¸ Issues") |" >> security-report.md
        echo "" >> security-report.md
        
        # Add detailed results for each scanner
        if [ "$CHECKOV_ISSUES" -gt 0 ] && [ -f "checkov-output.txt" ]; then
          echo "### ðŸ” Checkov Results" >> security-report.md
          echo "<details>" >> security-report.md
          echo "<summary>Click to view $CHECKOV_ISSUES Checkov issues</summary>" >> security-report.md
          echo "" >> security-report.md
          echo '```' >> security-report.md
          head -50 checkov-output.txt >> security-report.md
          echo '```' >> security-report.md
          echo "</details>" >> security-report.md
          echo "" >> security-report.md
        fi
        
        if [ "$TFSEC_ISSUES" -gt 0 ] && [ -f "tfsec-output.txt" ]; then
          echo "### ðŸ” tfsec Results" >> security-report.md
          echo "<details>" >> security-report.md
          echo "<summary>Click to view $TFSEC_ISSUES tfsec issues</summary>" >> security-report.md
          echo "" >> security-report.md
          echo '```' >> security-report.md
          head -50 tfsec-output.txt >> security-report.md
          echo '```' >> security-report.md
          echo "</details>" >> security-report.md
          echo "" >> security-report.md
        fi
        
        if [ "$TERRASCAN_ISSUES" -gt 0 ] && [ -f "terrascan-output.txt" ]; then
          echo "### ðŸ” Terrascan Results" >> security-report.md
          echo "<details>" >> security-report.md
          echo "<summary>Click to view $TERRASCAN_ISSUES Terrascan issues</summary>" >> security-report.md
          echo "" >> security-report.md
          echo '```' >> security-report.md
          head -50 terrascan-output.txt >> security-report.md
          echo '```' >> security-report.md
          echo "</details>" >> security-report.md
          echo "" >> security-report.md
        fi
        
        # Add security best practices check
        echo "### âœ… Security Features Verified" >> security-report.md
        echo "" >> security-report.md
        echo "The following security features are implemented in this module:" >> security-report.md
        echo "" >> security-report.md
        echo "- ðŸ” **Encryption at Rest**: Server-side encryption enabled by default" >> security-report.md
        echo "- ðŸ”’ **Encryption in Transit**: HTTPS-only access enforced" >> security-report.md
        echo "- ðŸš« **Public Access Prevention**: All public access blocked" >> security-report.md
        echo "- ðŸ“ **Versioning**: Bucket versioning enabled by default" >> security-report.md
        echo "- ðŸ·ï¸ **Naming Convention**: Enforced organizational naming pattern" >> security-report.md
        echo "- ðŸ“‹ **Lifecycle Management**: Optional lifecycle rules support" >> security-report.md
        echo "" >> security-report.md
        
        # Add links and footer
        echo "### ðŸ”— Additional Resources" >> security-report.md
        echo "" >> security-report.md
        echo "- ðŸ“‹ [Full Security Results](https://github.com/${{ github.repository }}/security/code-scanning)" >> security-report.md
        echo "- ðŸ“š [Security Documentation](.github/README.md#security-features)" >> security-report.md
        echo "- ðŸ›¡ï¸ [AWS S3 Security Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html)" >> security-report.md
        echo "" >> security-report.md
        echo "<sub>ðŸ¤– Security analysis completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")</sub>" >> security-report.md
        
        # Set output for GitHub Actions (properly escaped)
        {
          echo 'SECURITY_REPORT<<EOF'
          cat security-report.md
          echo EOF
        } >> $GITHUB_OUTPUT
        
        echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT

    - name: Comment PR with security results
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Read security report from file instead of using template literal
          let securityReport = '';
          try {
            securityReport = fs.readFileSync('./wizardai_aws_s3_bucket/security-report.md', 'utf8');
          } catch (error) {
            console.log('Could not read security report file:', error.message);
            securityReport = '## ðŸ›¡ï¸ Security Analysis Report\n\nâŒ Security report could not be generated.';
          }
          
          const totalIssues = parseInt('${{ steps.security_report.outputs.total_issues }}') || 0;
          
          // Find existing security comment to update or create new one
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const securityComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Security Analysis Report')
          );
          
          try {
            if (securityComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: securityComment.id,
                body: securityReport
              });
              console.log('âœ… Updated existing security comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: securityReport
              });
              console.log('âœ… Created new security comment');
            }
          } catch (error) {
            console.log('âš ï¸ Could not create/update security comment:', error.message);
            console.log('ðŸ“Š Security Report (logged instead):');
            console.log(securityReport);
          }
          
          // Set job status based on results
          if (totalIssues > 0) {
            core.warning(`Security analysis found ${totalIssues} issues. Please review and address them.`);
          } else {
            core.info('Security analysis passed with no issues found.');
          }

    - name: Upload security artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-analysis-results
        path: |
          ./wizardai_aws_s3_bucket/checkov-output.txt
          ./wizardai_aws_s3_bucket/checkov-results.sarif
          ./wizardai_aws_s3_bucket/tfsec-output.txt
          ./wizardai_aws_s3_bucket/tfsec-results.sarif
          ./wizardai_aws_s3_bucket/terrascan-output.txt
          ./wizardai_aws_s3_bucket/security-report.md