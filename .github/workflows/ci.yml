name: CI Pipeline

on:
  pull_request:
    branches: [ master, main ]
    paths:
      - 'wizardai_aws_s3_bucket/**'
      - '.github/workflows/**'
  push:
    branches: [ master, main ]
    paths:
      - 'wizardai_aws_s3_bucket/**'
      - '.github/workflows/**'

env:
  TF_VERSION: "1.6.0"
  GO_VERSION: "1.21"
  AWS_REGION: "us-west-2"

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./wizardai_aws_s3_bucket
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Format Check
      id: fmt
      run: |
        echo "## ğŸ“ Terraform Format Check" > ../terraform-validation-results.md
        echo "" >> ../terraform-validation-results.md
        
        if terraform fmt -check -recursive > ../fmt-output.txt 2>&1; then
          echo "âœ… **Format check passed** - All files are properly formatted" >> ../terraform-validation-results.md
          echo "fmt_result=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ **Format check failed** - Files need formatting" >> ../terraform-validation-results.md
          echo "" >> ../terraform-validation-results.md
          echo "<details>" >> ../terraform-validation-results.md
          echo "<summary>ğŸ“„ Click to view formatting issues</summary>" >> ../terraform-validation-results.md
          echo "" >> ../terraform-validation-results.md
          echo '```' >> ../terraform-validation-results.md
          cat ../fmt-output.txt >> ../terraform-validation-results.md
          echo '```' >> ../terraform-validation-results.md
          echo "</details>" >> ../terraform-validation-results.md
          echo "fmt_result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "" >> ../terraform-validation-results.md

    - name: Terraform Init
      id: init
      run: |
        echo "## ğŸš€ Terraform Init" >> ../terraform-validation-results.md
        echo "" >> ../terraform-validation-results.md
        
        if terraform init > ../init-output.txt 2>&1; then
          echo "âœ… **Initialization successful**" >> ../terraform-validation-results.md
          echo "init_result=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ **Initialization failed**" >> ../terraform-validation-results.md
          echo "" >> ../terraform-validation-results.md
          echo "<details>" >> ../terraform-validation-results.md
          echo "<summary>ğŸ“„ Click to view initialization errors</summary>" >> ../terraform-validation-results.md
          echo "" >> ../terraform-validation-results.md
          echo '```' >> ../terraform-validation-results.md
          cat ../init-output.txt >> ../terraform-validation-results.md
          echo '```' >> ../terraform-validation-results.md
          echo "</details>" >> ../terraform-validation-results.md
          echo "init_result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "" >> ../terraform-validation-results.md

    - name: Terraform Validate
      id: validate
      run: |
        echo "## âœ… Terraform Validate" >> ../terraform-validation-results.md
        echo "" >> ../terraform-validation-results.md
        
        if terraform validate > ../validate-output.txt 2>&1; then
          echo "âœ… **Validation successful** - Configuration is valid" >> ../terraform-validation-results.md
          echo "validate_result=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ **Validation failed** - Configuration has errors" >> ../terraform-validation-results.md
          echo "" >> ../terraform-validation-results.md
          echo "<details>" >> ../terraform-validation-results.md
          echo "<summary>ğŸ“„ Click to view validation errors</summary>" >> ../terraform-validation-results.md
          echo "" >> ../terraform-validation-results.md
          echo '```' >> ../terraform-validation-results.md
          cat ../validate-output.txt >> ../terraform-validation-results.md
          echo '```' >> ../terraform-validation-results.md
          echo "</details>" >> ../terraform-validation-results.md
          echo "validate_result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "" >> ../terraform-validation-results.md

    - name: Setup tflint
      uses: terraform-linters/setup-tflint@v6
      with:
        tflint_version: latest

    - name: Initialize tflint
      run: tflint --init

    - name: Run tflint
      id: tflint
      run: |
        echo "## ğŸ” TFLint Analysis" >> ../terraform-validation-results.md
        echo "" >> ../terraform-validation-results.md
        
        if tflint --format compact > ../tflint-output.txt 2>&1; then
          if [ -s ../tflint-output.txt ]; then
            # TFLint found issues but didn't fail
            ISSUE_COUNT=$(wc -l < ../tflint-output.txt)
            echo "âš ï¸ **TFLint completed with $ISSUE_COUNT warnings**" >> ../terraform-validation-results.md
            echo "" >> ../terraform-validation-results.md
            echo "<details>" >> ../terraform-validation-results.md
            echo "<summary>ğŸ“„ Click to view TFLint findings</summary>" >> ../terraform-validation-results.md
            echo "" >> ../terraform-validation-results.md
            echo '```' >> ../terraform-validation-results.md
            cat ../tflint-output.txt >> ../terraform-validation-results.md
            echo '```' >> ../terraform-validation-results.md
            echo "</details>" >> ../terraform-validation-results.md
            echo "tflint_result=warning" >> $GITHUB_OUTPUT
          else
            echo "âœ… **TFLint passed** - No issues found" >> ../terraform-validation-results.md
            echo "tflint_result=success" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ **TFLint failed** - Critical issues found" >> ../terraform-validation-results.md
          echo "" >> ../terraform-validation-results.md
          echo "<details>" >> ../terraform-validation-results.md
          echo "<summary>ğŸ“„ Click to view TFLint errors</summary>" >> ../terraform-validation-results.md
          echo "" >> ../terraform-validation-results.md
          echo '```' >> ../terraform-validation-results.md
          cat ../tflint-output.txt >> ../terraform-validation-results.md
          echo '```' >> ../terraform-validation-results.md
          echo "</details>" >> ../terraform-validation-results.md
          echo "tflint_result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "" >> ../terraform-validation-results.md

    - name: Upload validation results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: terraform-validation-results
        path: |
          terraform-validation-results.md
          fmt-output.txt
          init-output.txt
          validate-output.txt
          tflint-output.txt



  terraform-docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./wizardai_aws_s3_bucket
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate terraform docs
      uses: terraform-docs/gh-actions@v1.0.0
      with:
        working-dir: ./wizardai_aws_s3_bucket
        output-file: README.md
        output-method: inject
        git-push: false

    - name: Check if documentation is up to date
      id: docs
      run: |
        echo "## ğŸ“š Documentation Check" > ../terraform-docs-results.md
        echo "" >> ../terraform-docs-results.md
        
        if git diff --exit-code README.md > ../docs-diff.txt 2>&1; then
          echo "âœ… **Documentation is up to date** - No changes needed" >> ../terraform-docs-results.md
          echo "docs_result=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ **Documentation is out of date** - Please run terraform-docs and commit changes" >> ../terraform-docs-results.md
          echo "" >> ../terraform-docs-results.md
          echo "<details>" >> ../terraform-docs-results.md
          echo "<summary>ğŸ“„ Click to view documentation changes needed</summary>" >> ../terraform-docs-results.md
          echo "" >> ../terraform-docs-results.md
          echo '```diff' >> ../terraform-docs-results.md
          cat ../docs-diff.txt >> ../terraform-docs-results.md
          echo '```' >> ../terraform-docs-results.md
          echo "</details>" >> ../terraform-docs-results.md
          echo "" >> ../terraform-docs-results.md
          echo "ğŸ’¡ **To fix:** Run \`terraform-docs markdown table --output-file README.md .\` in the module directory" >> ../terraform-docs-results.md
          echo "docs_result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Upload docs results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: terraform-docs-results
        path: |
          terraform-docs-results.md
          docs-diff.txt

  terratest:
    name: Terratest
    runs-on: ubuntu-latest
    needs: [terraform-validate]
    if: github.event_name == 'pull_request'
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./wizardai_aws_s3_bucket/test
    
    strategy:
      matrix:
        test: [basic, production, validation]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v6
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
        role-session-name: GitHubActions-Terratest-${{ github.run_id }}-${{ matrix.test }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: make deps

    - name: Run tests
      id: test
      run: |
        # Create test results file
        echo "## ğŸ§ª Terratest Results - ${{ matrix.test }}" > ../../terratest-${{ matrix.test }}-results.md
        echo "" >> ../../terratest-${{ matrix.test }}-results.md
        
        # Run the appropriate test
        case "${{ matrix.test }}" in
          basic)
            if make test-basic > ../../test-${{ matrix.test }}-output.txt 2>&1; then
              echo "âœ… **Basic tests passed** - All infrastructure tests successful" >> ../../terratest-${{ matrix.test }}-results.md
              echo "test_result=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ **Basic tests failed** - Infrastructure tests encountered errors" >> ../../terratest-${{ matrix.test }}-results.md
              echo "" >> ../../terratest-${{ matrix.test }}-results.md
              echo "<details>" >> ../../terratest-${{ matrix.test }}-results.md
              echo "<summary>ğŸ“„ Click to view test failures</summary>" >> ../../terratest-${{ matrix.test }}-results.md
              echo "" >> ../../terratest-${{ matrix.test }}-results.md
              echo '```' >> ../../terratest-${{ matrix.test }}-results.md
              tail -50 ../../test-${{ matrix.test }}-output.txt >> ../../terratest-${{ matrix.test }}-results.md
              echo '```' >> ../../terratest-${{ matrix.test }}-results.md
              echo "</details>" >> ../../terratest-${{ matrix.test }}-results.md
              echo "test_result=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            ;;
          production)
            if make test-production > ../../test-${{ matrix.test }}-output.txt 2>&1; then
              echo "âœ… **Production tests passed** - Production-grade configuration validated" >> ../../terratest-${{ matrix.test }}-results.md
              echo "test_result=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ **Production tests failed** - Production configuration issues found" >> ../../terratest-${{ matrix.test }}-results.md
              echo "" >> ../../terratest-${{ matrix.test }}-results.md
              echo "<details>" >> ../../terratest-${{ matrix.test }}-results.md
              echo "<summary>ğŸ“„ Click to view test failures</summary>" >> ../../terratest-${{ matrix.test }}-results.md
              echo "" >> ../../terratest-${{ matrix.test }}-results.md
              echo '```' >> ../../terratest-${{ matrix.test }}-results.md
              tail -50 ../../test-${{ matrix.test }}-output.txt >> ../../terratest-${{ matrix.test }}-results.md
              echo '```' >> ../../terratest-${{ matrix.test }}-results.md
              echo "</details>" >> ../../terratest-${{ matrix.test }}-results.md
              echo "test_result=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            ;;
          validation)
            if make test-validation > ../../test-${{ matrix.test }}-output.txt 2>&1; then
              echo "âœ… **Validation tests passed** - Input validation working correctly" >> ../../terratest-${{ matrix.test }}-results.md
              echo "test_result=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ **Validation tests failed** - Input validation issues detected" >> ../../terratest-${{ matrix.test }}-results.md
              echo "" >> ../../terratest-${{ matrix.test }}-results.md
              echo "<details>" >> ../../terratest-${{ matrix.test }}-results.md
              echo "<summary>ğŸ“„ Click to view test failures</summary>" >> ../../terratest-${{ matrix.test }}-results.md
              echo "" >> ../../terratest-${{ matrix.test }}-results.md
              echo '```' >> ../../terratest-${{ matrix.test }}-results.md
              tail -50 ../../test-${{ matrix.test }}-output.txt >> ../../terratest-${{ matrix.test }}-results.md
              echo '```' >> ../../terratest-${{ matrix.test }}-results.md
              echo "</details>" >> ../../terratest-${{ matrix.test }}-results.md
              echo "test_result=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            ;;
        esac
        echo "" >> ../../terratest-${{ matrix.test }}-results.md
      env:
        AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.test }}
        path: |
          ./wizardai_aws_s3_bucket/test/coverage.out
          ./wizardai_aws_s3_bucket/test/coverage.html
          terratest-${{ matrix.test }}-results.md
          test-${{ matrix.test }}-output.txt

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./wizardai_aws_s3_bucket/examples/basic
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
        role-session-name: GitHubActions-TerraformPlan-${{ github.run_id }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      id: plan
      run: |
        # Generate unique bucket name for PR
        PR_NUMBER="${{ github.event.number }}"
        BUCKET_NAME="pr-test-${PR_NUMBER}"
        
        # Run terraform plan
        terraform plan \
          -var="bucket_name=${BUCKET_NAME}" \
          -var="environment=development" \
          -out=tfplan \
          -no-color > plan-output.txt 2>&1
        
        # Capture exit code
        PLAN_EXIT_CODE=$?
        
        # Create plan summary
        echo "## ğŸ“‹ Terraform Plan Results" > plan-summary.md
        echo "" >> plan-summary.md
        
        if [ $PLAN_EXIT_CODE -eq 0 ]; then
          echo "âœ… **Plan succeeded**" >> plan-summary.md
        else
          echo "âŒ **Plan failed**" >> plan-summary.md
        fi
        echo "" >> plan-summary.md
        
        # Extract plan summary
        if grep -q "Plan:" plan-output.txt; then
          PLAN_SUMMARY=$(grep "Plan:" plan-output.txt | tail -1)
          echo "### Changes Summary" >> plan-summary.md
          echo "$PLAN_SUMMARY" >> plan-summary.md
          echo "" >> plan-summary.md
        fi
        
        # Add full plan in collapsible section
        echo "<details>" >> plan-summary.md
        echo "<summary>ğŸ“„ Click to view full Terraform plan</summary>" >> plan-summary.md
        echo "" >> plan-summary.md
        echo '```terraform' >> plan-summary.md
        cat plan-output.txt >> plan-summary.md
        echo '```' >> plan-summary.md
        echo "</details>" >> plan-summary.md
        echo "" >> plan-summary.md
        echo "ğŸ”— **Plan generated for PR #${{ github.event.number }}**" >> plan-summary.md
        
        # Set output for use in PR comment
        {
          echo 'PLAN_SUMMARY<<EOF'
          cat plan-summary.md
          echo EOF
        } >> $GITHUB_OUTPUT
        
        exit $PLAN_EXIT_CODE

    - name: Upload plan output
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: terraform-plan
        path: |
          ./wizardai_aws_s3_bucket/examples/basic/tfplan
          ./wizardai_aws_s3_bucket/examples/basic/plan-output.txt
          ./wizardai_aws_s3_bucket/examples/basic/plan-summary.md

  cost-estimation:
    name: Cost Estimation
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.event_name == 'pull_request' && secrets.INFRACOST_API_KEY != ''
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./wizardai_aws_s3_bucket/examples/basic
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
        role-session-name: GitHubActions-CostEstimation-${{ github.run_id }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: terraform init

    - name: Generate Terraform Plan for Infracost
      run: |
        PR_NUMBER="${{ github.event.number }}"
        BUCKET_NAME="pr-test-${PR_NUMBER}"
        
        terraform plan \
          -var="bucket_name=${BUCKET_NAME}" \
          -var="environment=development" \
          -out=tfplan

    - name: Setup Infracost
      uses: infracost/actions/setup@v2
      with:
        api-key: ${{ secrets.INFRACOST_API_KEY }}

    - name: Generate Infracost breakdown
      id: infracost
      run: |
        # Generate Infracost breakdown
        infracost breakdown --path=tfplan --format=json --out-file=infracost.json
        
        # Generate table format for PR comment
        infracost breakdown --path=tfplan --format=table > infracost-table.txt
        
        # Create cost summary
        echo "## ğŸ’° Cost Estimation" > cost-summary.md
        echo "" >> cost-summary.md
        
        # Check if there are any costs
        if grep -q "OVERALL TOTAL" infracost-table.txt; then
          TOTAL_COST=$(grep "OVERALL TOTAL" infracost-table.txt | awk '{print $NF}')
          echo "### Monthly Cost Estimate: **$TOTAL_COST**" >> cost-summary.md
          echo "" >> cost-summary.md
          
          echo "<details>" >> cost-summary.md
          echo "<summary>ğŸ“Š Click to view detailed cost breakdown</summary>" >> cost-summary.md
          echo "" >> cost-summary.md
          echo '```' >> cost-summary.md
          cat infracost-table.txt >> cost-summary.md
          echo '```' >> cost-summary.md
          echo "</details>" >> cost-summary.md
        else
          echo "â„¹ï¸ **No costs detected** - This infrastructure appears to be within AWS free tier or uses free resources." >> cost-summary.md
        fi
        echo "" >> cost-summary.md
        echo "ğŸ’¡ **Note**: Costs are estimates and may vary based on actual usage." >> cost-summary.md
        echo "" >> cost-summary.md
        echo "ğŸ”— [Learn more about Infracost](https://www.infracost.io/)" >> cost-summary.md
        
        # Set output for use in PR comment
        {
          echo 'COST_SUMMARY<<EOF'
          cat cost-summary.md
          echo EOF
        } >> $GITHUB_OUTPUT

    - name: Upload cost estimation
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cost-estimation
        path: |
          ./wizardai_aws_s3_bucket/examples/basic/infracost.json
          ./wizardai_aws_s3_bucket/examples/basic/infracost-table.txt
          ./wizardai_aws_s3_bucket/examples/basic/cost-summary.md

  pr-comment:
    name: PR Comment Summary
    runs-on: ubuntu-latest
    needs: [terraform-validate, terraform-docs, terratest, terraform-plan, cost-estimation]
    if: always() && github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      continue-on-error: true

    - name: Create comprehensive PR comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Initialize comment sections
          let comment = `# ğŸš€ CI/CD Pipeline Results for PR #${{ github.event.number }}\n\n`;
          
          // Job status summary
          const jobs = [
            { name: 'Terraform Validation', result: '${{ needs.terraform-validate.result }}', icon: '${{ needs.terraform-validate.result }}' === 'success' ? 'âœ…' : 'âŒ' },
            { name: 'Documentation Check', result: '${{ needs.terraform-docs.result }}', icon: '${{ needs.terraform-docs.result }}' === 'success' ? 'âœ…' : 'âŒ' },
            { name: 'Terratest', result: '${{ needs.terratest.result }}', icon: '${{ needs.terratest.result }}' === 'success' ? 'âœ…' : '${{ needs.terratest.result }}' === 'skipped' ? 'â­ï¸' : 'âŒ' },
            { name: 'Terraform Plan', result: '${{ needs.terraform-plan.result }}', icon: '${{ needs.terraform-plan.result }}' === 'success' ? 'âœ…' : 'âŒ' },
            { name: 'Cost Estimation', result: '${{ needs.cost-estimation.result }}', icon: '${{ needs.cost-estimation.result }}' === 'success' ? 'âœ…' : '${{ needs.cost-estimation.result }}' === 'skipped' ? 'â­ï¸' : 'âŒ' }
          ];
          
          comment += `## ğŸ“Š Pipeline Status\n\n`;
          jobs.forEach(job => {
            comment += `${job.icon} **${job.name}**: ${job.result}\n`;
          });
          comment += `\n`;
          
          // Add terraform validation results
          try {
            const validationResults = fs.readFileSync('terraform-validation-results/terraform-validation-results.md', 'utf8');
            comment += validationResults + '\n\n';
          } catch (error) {
            comment += `## ğŸ“ Terraform Validation Results\n\n`;
            if ('${{ needs.terraform-validate.result }}' === 'success') {
              comment += `âœ… All validation checks passed (format, init, validate, lint).\n\n`;
            } else {
              comment += `âŒ Validation failed. Please check the workflow logs for details.\n\n`;
            }
          }
          
          // Add terraform docs results
          try {
            const docsResults = fs.readFileSync('terraform-docs-results/terraform-docs-results.md', 'utf8');
            comment += docsResults + '\n\n';
          } catch (error) {
            comment += `## ğŸ“š Documentation Check Results\n\n`;
            if ('${{ needs.terraform-docs.result }}' === 'success') {
              comment += `âœ… Documentation is up to date.\n\n`;
            } else {
              comment += `âŒ Documentation check failed. Please check the workflow logs for details.\n\n`;
            }
          }
          
          // Add terratest results
          const testTypes = ['basic', 'production', 'validation'];
          let testResultsFound = false;
          
          for (const testType of testTypes) {
            try {
              const testResults = fs.readFileSync(`test-results-${testType}/terratest-${testType}-results.md`, 'utf8');
              if (!testResultsFound) {
                comment += `## ğŸ§ª Terratest Results\n\n`;
                testResultsFound = true;
              }
              comment += testResults + '\n';
            } catch (error) {
              // Test result file not found, skip
            }
          }
          
          if (!testResultsFound) {
            comment += `## ğŸ§ª Terratest Results\n\n`;
            if ('${{ needs.terratest.result }}' === 'success') {
              comment += `âœ… All infrastructure tests passed.\n\n`;
            } else if ('${{ needs.terratest.result }}' === 'skipped') {
              comment += `â­ï¸ Tests were skipped (not a pull request).\n\n`;
            } else {
              comment += `âŒ Some tests failed. Please check the workflow logs for details.\n\n`;
            }
          }
          
          // Add terraform plan results
          try {
            const planSummary = fs.readFileSync('terraform-plan/plan-summary.md', 'utf8');
            comment += planSummary + '\n\n';
          } catch (error) {
            comment += `## ğŸ“‹ Terraform Plan Results\n\n`;
            if ('${{ needs.terraform-plan.result }}' === 'success') {
              comment += `âœ… Terraform plan completed successfully.\n\n`;
            } else if ('${{ needs.terraform-plan.result }}' === 'failure') {
              comment += `âŒ Terraform plan failed. Please check the workflow logs for details.\n\n`;
            } else {
              comment += `â­ï¸ Terraform plan was skipped.\n\n`;
            }
          }
          
          // Add cost estimation results
          try {
            const costSummary = fs.readFileSync('cost-estimation/cost-summary.md', 'utf8');
            comment += costSummary + '\n\n';
          } catch (error) {
            if ('${{ secrets.INFRACOST_API_KEY }}' === '') {
              comment += `## ğŸ’° Cost Estimation\n\n`;
              comment += `â„¹ï¸ **Cost estimation skipped** - Infracost API key not configured.\n\n`;
              comment += `To enable cost estimation, add \`INFRACOST_API_KEY\` to repository secrets.\n\n`;
            } else if ('${{ needs.cost-estimation.result }}' === 'failure') {
              comment += `## ğŸ’° Cost Estimation\n\n`;
              comment += `âŒ Cost estimation failed. Please check the workflow logs for details.\n\n`;
            }
          }
          
          // Note about security scan
          comment += `## ğŸ”’ Security Scan Results\n\n`;
          comment += `ğŸ” Security analysis is running in a separate workflow. Results will be posted as a separate comment.\n\n`;
          comment += `ğŸ“‹ Check the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning) for detailed SARIF results.\n\n`;
          
          // Add footer with useful links
          comment += `---\n\n`;
          comment += `### ğŸ”— Useful Links\n\n`;
          comment += `- ğŸ“‹ [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
          comment += `- ğŸ”’ [Security Results](https://github.com/${{ github.repository }}/security/code-scanning)\n`;
          comment += `- ğŸ“Š [All Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
          comment += `- ğŸ“š [CI/CD Documentation](.github/README.md)\n\n`;
          
          // Add timestamp
          const now = new Date().toISOString();
          comment += `<sub>ğŸ¤– This comment was automatically generated at ${now}</sub>`;
          
          // Find existing comment to update or create new one
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('CI/CD Pipeline Results for PR')
          );
          
          try {
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('âœ… Updated existing PR comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('âœ… Created new PR comment');
            }
          } catch (error) {
            console.log('âš ï¸ Could not create/update PR comment:', error.message);
            console.log('ğŸ“Š CI/CD Pipeline Results (logged instead):');
            console.log(comment);
            
            // Add to step summary instead
            core.summary.addHeading('CI/CD Pipeline Results');
            core.summary.addRaw(comment);
            await core.summary.write();
          }